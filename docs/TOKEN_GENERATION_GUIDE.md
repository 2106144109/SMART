# ğŸ“š 30ç§’æ•°æ®Tokenè¯å…¸ç”ŸæˆæŒ‡å—

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿæˆæ–°è¯å…¸ï¼Ÿ

SMARTæ¨¡å‹ä½¿ç”¨**tokenåŒ–çš„è½¨è¿¹è¡¨ç¤º**ï¼ˆç±»ä¼¼è¯­è¨€æ¨¡å‹çš„è¯æ±‡è¡¨ï¼‰ã€‚ç”±äºæˆ‘ä»¬æ”¹å˜äº†æ—¶é—´é—´éš”ï¼ˆ10ç§’â†’30ç§’ï¼‰ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆé€‚é…30ç§’æ•°æ®çš„è¯å…¸ã€‚

### Tokenè¯å…¸çš„ä½œç”¨
- **ç¦»æ•£åŒ–è½¨è¿¹**: å°†è¿ç»­çš„è½¨è¿¹è¡¨ç¤ºä¸ºç¦»æ•£çš„tokenåºåˆ—
- **å‹ç¼©è¡¨ç¤º**: ç”¨2048ä¸ªtokenä»£è¡¨æ‰€æœ‰å¯èƒ½çš„è½¨è¿¹æ¨¡å¼
- **åŠ é€Ÿæ¨ç†**: Tokené¢„æµ‹æ¯”ç›´æ¥é¢„æµ‹åæ ‡æ›´é«˜æ•ˆ

---

## ğŸš€ ä¸€é”®ç”Ÿæˆï¼ˆæ¨èï¼‰

```bash
cd /home/mahexing/SMART-main

# è¿è¡Œè‡ªåŠ¨è„šæœ¬
bash generate_30s_tokens.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
1. âœ… ä»è®­ç»ƒæ•°æ®ä¸­æå–è½¨è¿¹æ ·æœ¬
2. âœ… ä½¿ç”¨K-meansèšç±»ç”Ÿæˆ2048ä¸ªè½¨è¿¹åŸå‹
3. âœ… è½¬æ¢ä¸ºæ¨¡å‹å¯ç”¨çš„tokenæ ¼å¼
4. âœ… éªŒè¯å’Œä¿å­˜æ–‡ä»¶

**é¢„è®¡æ—¶é—´**: 10-30åˆ†é’Ÿ

---

## ğŸ“‹ æ‰‹åŠ¨æ­¥éª¤ï¼ˆè¯¦ç»†ï¼‰

### æ­¥éª¤1: ç”Ÿæˆè¯æ±‡è¡¨

```bash
python generate_30s_vocabulary.py
```

**å‚æ•°è¯´æ˜**:
- **è¯æ±‡è¡¨å¤§å°**: 2048ï¼ˆä¸æ¨¡å‹é…ç½®ä¸€è‡´ï¼‰
- **æ—¶é—´æ­¥æ•°**: 2æ­¥ï¼ˆæ¯ä¸ªtokenè¦†ç›–90ç§’çš„è½¨è¿¹ï¼‰
- **æœ€å¤§æ ·æœ¬æ•°**: 50000ï¼ˆå¯ä»¥å…¨éƒ¨ä½¿ç”¨ï¼‰
- **è¾“å‡º**: `data/maritime_motion_vocab_30s.pt`

**è¿™ä¸€æ­¥çš„å·¥ä½œ**:
1. ä»`data/maritime_windows_30s/train/`åŠ è½½è®­ç»ƒæ•°æ®
2. æå–è½¨è¿¹ç‰‡æ®µï¼ˆè¿ç»­3ä¸ªæ—¶é—´ç‚¹ï¼Œ90ç§’ï¼‰
3. ä½¿ç”¨K-diskèšç±»ç®—æ³•èšç±»ä¸º2048ä¸ªä¸­å¿ƒ
4. ä¿å­˜è¯æ±‡è¡¨

### æ­¥éª¤2: è½¬æ¢ä¸ºTokenæ ¼å¼

```bash
python convert_vocab_to_token.py \
  --vocab data/maritime_motion_vocab_30s.pt \
  --output smart/tokens/maritime_tokens_30s.pkl
```

**è¿™ä¸€æ­¥çš„å·¥ä½œ**:
1. åŠ è½½è¯æ±‡è¡¨æ–‡ä»¶
2. æå–tokenå½¢çŠ¶ã€è½¨è¿¹å’Œå®Œæ•´tokenä¿¡æ¯
3. è½¬æ¢ä¸ºæ¨¡å‹éœ€è¦çš„pklæ ¼å¼
4. ä¿å­˜åˆ°`smart/tokens/`ç›®å½•

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### 10ç§’æ•°æ® vs 30ç§’æ•°æ®

| å‚æ•° | 10ç§’æ•°æ® | 30ç§’æ•°æ® | è¯´æ˜ |
|------|---------|---------|------|
| **è¯æ±‡è¡¨å¤§å°** | 2048 | 2048 | ä¿æŒä¸€è‡´ |
| **æ—¶é—´æ­¥æ•°** | 5æ­¥ | 2æ­¥ | è°ƒæ•´ä»¥åŒ¹é…æ—¶é—´é—´éš” |
| **Tokenè¦†ç›–æ—¶é•¿** | 60ç§’ | 90ç§’ | 30ç§’Ã—3ç‚¹ |
| **è®­ç»ƒæ ·æœ¬æ•°** | ~200K | ~37K | æ•°æ®é‡å‡å°‘ |
| **æ–‡ä»¶å¤§å°** | ~5MB | ~5MB | ç›¸è¿‘ |

### ä¸ºä»€ä¹ˆ30ç§’æ•°æ®ç”¨shift=2ï¼Ÿ

```
10ç§’æ•°æ®: shift=5 â†’ 6ä¸ªç‚¹ â†’ 60ç§’
30ç§’æ•°æ®: shift=2 â†’ 3ä¸ªç‚¹ â†’ 90ç§’

åŸç†ï¼šæ¯ä¸ªtokenéœ€è¦æ•æ‰è¶³å¤Ÿé•¿çš„è½¨è¿¹æ¨¡å¼
- å¤ªçŸ­ï¼ˆ1-2ç§’ï¼‰ï¼šæ— æ³•ä½“ç°è¿åŠ¨è¶‹åŠ¿
- å¤ªé•¿ï¼ˆ>5åˆ†é’Ÿï¼‰ï¼šè¿‡äºå…·ä½“ï¼Œæ³›åŒ–æ€§å·®
- é€‚ä¸­ï¼ˆ60-120ç§’ï¼‰ï¼šå¹³è¡¡ç»†èŠ‚å’Œæ³›åŒ–
```

---

## ğŸ”§ ç”Ÿæˆçš„æ–‡ä»¶

### 1. è¯æ±‡è¡¨æ–‡ä»¶
**è·¯å¾„**: `data/maritime_motion_vocab_30s.pt`

**å†…å®¹**:
```python
{
    'token': {
        'ship': torch.Tensor([2048, 4, 2])  # 2048ä¸ªè½¨è¿¹çš„å¤šè¾¹å½¢è¡¨ç¤º
    },
    'traj': {
        'ship': torch.Tensor([2048, 3, 3])  # 2048ä¸ªè½¨è¿¹çš„(x,y,Î¸)åºåˆ—
    },
    'token_all': {
        'ship': torch.Tensor([2048, 3, 4, 2])  # å®Œæ•´çš„æ—¶åºå¤šè¾¹å½¢
    }
}
```

### 2. Tokenæ–‡ä»¶
**è·¯å¾„**: `smart/tokens/maritime_tokens_30s.pkl`

**å†…å®¹**:
```python
{
    'token': np.array([2048, 4, 2]),      # Tokenå½¢çŠ¶
    'traj': np.array([2048, 3, 3]),       # è½¨è¿¹åºåˆ—
    'token_all': np.array([2048, 3, 4, 2]) # å®Œæ•´ä¿¡æ¯
}
```

---

## ğŸ” éªŒè¯ç”Ÿæˆç»“æœ

### æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
```bash
ls -lh data/maritime_motion_vocab_30s.pt
ls -lh smart/tokens/maritime_tokens_30s.pkl
```

### éªŒè¯è¯æ±‡è¡¨å†…å®¹
```python
import torch

vocab = torch.load('data/maritime_motion_vocab_30s.pt')
print("Tokenå½¢çŠ¶:", vocab['token']['ship'].shape)  # åº”è¯¥æ˜¯ [2048, 4, 2]
print("Trajå½¢çŠ¶:", vocab['traj']['ship'].shape)    # åº”è¯¥æ˜¯ [2048, 3, 3]
```

### éªŒè¯Tokenæ–‡ä»¶
```python
import pickle

with open('smart/tokens/maritime_tokens_30s.pkl', 'rb') as f:
    tokens = pickle.load(f)
    
print("Tokené”®:", list(tokens.keys()))
print("Tokenå½¢çŠ¶:", tokens['token'].shape)  # åº”è¯¥æ˜¯ (2048, 4, 2)
```

---

## âš™ï¸ é…ç½®æ¨¡å‹ä½¿ç”¨æ–°Token

### æ–¹æ¡ˆ1: é‡å‘½åæ–‡ä»¶ï¼ˆæ¨èï¼‰

æ¨¡å‹é»˜è®¤æŸ¥æ‰¾ `smart/tokens/maritime_tokens.pkl`ï¼Œç›´æ¥å¤åˆ¶æˆ–é‡å‘½åï¼š

```bash
# å¤‡ä»½æ—§çš„tokenæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
mv smart/tokens/maritime_tokens.pkl smart/tokens/maritime_tokens_10s.pkl.backup

# ä½¿ç”¨30ç§’çš„token
cp smart/tokens/maritime_tokens_30s.pkl smart/tokens/maritime_tokens.pkl
```

### æ–¹æ¡ˆ2: ä¿®æ”¹æ¨¡å‹ä»£ç 

ç¼–è¾‘ `smart/model/smart.py` ç¬¬92è¡Œï¼š

```python
# ä¿®æ”¹å‰
if self.dataset == 'maritime':
    self.token_path = os.path.join(module_dir, 'tokens/maritime_tokens.pkl')

# ä¿®æ”¹å
if self.dataset == 'maritime':
    self.token_path = os.path.join(module_dir, 'tokens/maritime_tokens_30s.pkl')
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### èšç±»è´¨é‡æŒ‡æ ‡
- **ç°‡å†…è·ç¦»**: è¶Šå°è¶Šå¥½ï¼ˆè¡¨ç¤ºèšç±»ç´§å¯†ï¼‰
- **ç°‡é—´è·ç¦»**: è¶Šå¤§è¶Šå¥½ï¼ˆè¡¨ç¤ºåŒºåˆ†æ˜æ˜¾ï¼‰
- **è¦†ç›–ç‡**: >95%ï¼ˆå¤§éƒ¨åˆ†è½¨è¿¹èƒ½åŒ¹é…åˆ°åˆé€‚çš„tokenï¼‰

### Tokenåˆ†å¸ƒ
- **å¸¸è§token**: ç›´çº¿è¡Œé©¶ã€ç¼“æ…¢è½¬å¼¯
- **ç½•è§token**: æ€¥è½¬å¼¯ã€å¤æ‚æœºåŠ¨
- **åˆ†å¸ƒ**: ç¬¦åˆå¹‚å¾‹åˆ†å¸ƒï¼ˆå°‘æ•°tokenå å¤šæ•°ï¼‰

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: èšç±»è¿è¡Œå¾ˆæ…¢ï¼Ÿ
**A**: æ­£å¸¸ç°è±¡ï¼Œå¤§è§„æ¨¡èšç±»éœ€è¦æ—¶é—´
- å‡å°‘`max_samples`ï¼ˆå¦‚ä»50000é™åˆ°20000ï¼‰
- ä½¿ç”¨æ›´å¼ºå¤§çš„CPU
- é¢„è®¡æ—¶é—´ï¼š10-30åˆ†é’Ÿ

### Q2: å†…å­˜ä¸è¶³ï¼Ÿ
**A**: è°ƒæ•´å‚æ•°
```python
config = {
    'max_samples': 20000,  # å‡å°‘æ ·æœ¬æ•°
    'num_clusters': 1024,  # å‡å°‘è¯æ±‡è¡¨å¤§å°
}
```

### Q3: ç”Ÿæˆçš„tokenæ•ˆæœä¸å¥½ï¼Ÿ
**A**: è°ƒæ•´å‚æ•°
- å¢åŠ `tolerance`ï¼ˆ0.15â†’0.2ï¼‰ï¼šæ›´æ¾æ•£çš„èšç±»
- è°ƒæ•´`shift`ï¼ˆ2â†’3ï¼‰ï¼šæ›´é•¿çš„è½¨è¿¹ç‰‡æ®µ
- å¢åŠ `num_clusters`ï¼ˆ2048â†’4096ï¼‰ï¼šæ›´ç»†ç²’åº¦

### Q4: æ‰¾ä¸åˆ°è®­ç»ƒæ•°æ®ï¼Ÿ
**A**: ç¡®ä¿å…ˆè¿è¡Œæ•°æ®ç”Ÿæˆ
```bash
bash regenerate_30s_data.sh
```

---

## ğŸ¯ å®Œæ•´æµç¨‹æ€»ç»“

```bash
# 1. ç”Ÿæˆ30ç§’è®­ç»ƒæ•°æ®
bash regenerate_30s_data.sh

# 2. ç”Ÿæˆè¯å…¸
bash generate_30s_tokens.sh

# 3. é…ç½®æ¨¡å‹ä½¿ç”¨æ–°token
cp smart/tokens/maritime_tokens_30s.pkl smart/tokens/maritime_tokens.pkl

# 4. æ›´æ–°è®­ç»ƒé…ç½®
# ç¼–è¾‘ configs/train/train_maritime.yaml
# train_raw_dir: ["data/maritime_windows_30s/train"]

# 5. æµ‹è¯•æ•°æ®åŠ è½½
python test_maritime_data.py

# 6. å¼€å§‹è®­ç»ƒ
python train.py --config configs/train/train_maritime.yaml \
  --save_ckpt_path logs/maritime_30s_checkpoints
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

- **è¯å…¸ç”Ÿæˆè„šæœ¬**: `generate_30s_vocabulary.py`
- **è½¬æ¢è„šæœ¬**: `convert_vocab_to_token.py`
- **è‡ªåŠ¨åŒ–è„šæœ¬**: `generate_30s_tokens.sh`
- **èšç±»ç®—æ³•**: `maritime_traj_clustering.py`

---

**åˆ›å»ºæ—¶é—´**: 2025-10-17  
**é€‚ç”¨ç‰ˆæœ¬**: 30ç§’æ—¶é—´é—´éš”é…ç½®  
**çŠ¶æ€**: å°±ç»ª

